<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ¤‘ğŸ¤‘ğŸ¤‘ğŸ¤‘</title>

    <!-- Vuetify ç›¸é—œè³‡æº -->
    <link
      href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.0.4/dist/pako.min.js"></script>

    <style>
      [v-cloak] {
        display: none;
      }
      .selected-chip {
        background-color: #4caf50 !important; /* ç¶ è‰²èƒŒæ™¯ */
        color: white !important; /* ç™½è‰²å­—é«” */
      }
      .unselected-chip {
        background-color: #e0e0e0 !important; /* ç°è‰²èƒŒæ™¯ */
        color: black !important; /* é»‘è‰²å­—é«” */
      }
    </style>
  </head>
  <body>
    <div id="app" v-cloak>
      <v-app>
        <v-main>
          <v-container>
            <v-row justify="center">
              <v-col cols="12" md="8">
                <v-card class="mb-6">
                  <v-card-title class="text-center text-h4 py-4">
                    èšæœƒè²»ç”¨åˆ†æ”¤è¨ˆç®—å™¨
                  </v-card-title>
                </v-card>

                <!-- åƒèˆ‡è€…ç®¡ç†çµ„ä»¶ -->
                <participant-manager
                  :participants="participants"
                  @add-participant="addParticipant"
                  @delete-participant="deleteParticipant"
                  @reset-participants="resetParticipants"
                ></participant-manager>

                <!-- æ”¯å‡ºç®¡ç†çµ„ä»¶ -->
                <expense-manager
                  :participants="participants"
                  :expenses="expenses"
                  @add-expense="addExpense"
                  @delete-expense="deleteExpense"
                  @update-expense="updateExpense"
                  @reset-expenses="resetExpenses"
                  @notify-update="showNotification"
                ></expense-manager>

                <!-- çµæœé¡¯ç¤ºçµ„ä»¶ -->
                <result-display
                  :participants="participants"
                  :expenses="expenses"
                  @share="shareDetails"
                  @export="exportDetails"
                ></result-display>
              </v-col>
            </v-row>
          </v-container>
        </v-main>

        <!-- ç¢ºèªå°è©±æ¡† -->
        <v-dialog v-model="dialog.show" max-width="500">
          <v-card>
            <v-card-title>{{ dialog.title }}</v-card-title>
            <v-card-text class="white-space-pre-line"
              >{{ dialog.text }}</v-card-text
            >
            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn color="grey" variant="text" @click="dialog.show = false">
                {{ dialog.cancelText }}
              </v-btn>
              <v-btn
                :color="dialog.confirmColor"
                variant="text"
                @click="handleDialogConfirm"
              >
                {{ dialog.confirmText }}
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>

        <!-- é€šçŸ¥çµ„ä»¶ -->
        <v-snackbar
          v-model="snackbar.show"
          :color="snackbar.color"
          :timeout="2000"
          location="top"
        >
          {{ snackbar.text }}
        </v-snackbar>
      </v-app>
    </div>

    <!-- åƒèˆ‡è€…ç®¡ç†çµ„ä»¶æ¨¡æ¿ -->
    <script type="text/x-template" id="participant-manager-template">
      <v-card class="mb-6">
        <v-card-title class="d-flex justify-space-between align-center">
          èª°æœ‰ä¾†
          <v-btn
            color="error"
            variant="text"
            @click="$emit('reset-participants')"
            :disabled="!participants.length"
          >
            æ²’äººä¾†
          </v-btn>
        </v-card-title>
        <v-card-text>
          <v-form @submit.prevent="addNewParticipant">
            <v-row>
              <v-col cols="12" sm="8">
                <v-text-field
                  v-model="newParticipantName"
                  label="è¼¸å…¥èª°æœ‰ä¾†"
                  @keyup.enter="addNewParticipant"
                  hide-details
                ></v-text-field>
              </v-col>
              <v-col cols="12" sm="4">
                <v-btn
                  color="primary"
                  block
                  @click="addNewParticipant"
                  :disabled="!newParticipantName"
                >
                  ä»–ä¾†äº†
                </v-btn>
              </v-col>
            </v-row>
          </v-form>
          <v-row class="mt-4">
            <v-col cols="12">
              <v-chip
                v-for="(participant, index) in participants"
                :key="participant"
                @click="$emit('delete-participant', index)"
                class="ma-2"
              >
                {{ participant }}
                <v-icon right color="red" class="ml-1">mdi-delete</v-icon>
              </v-chip>
            </v-col>
          </v-row>
          <v-alert
            v-if="!participants.length"
            type="info"
            text="æˆ‘é‚„ä¸çŸ¥é“èª°æœ‰ä¾†,è«‹å¡«"
          ></v-alert>
        </v-card-text>
      </v-card>
    </script>

    <!-- æ”¯å‡ºç®¡ç†çµ„ä»¶æ¨¡æ¿ -->
    <script type="text/x-template" id="expense-manager-template">
      <v-card class="mb-6">
        <v-card-title>èª°èŠ±çš„éŒ¢  å‡ºä¾†</v-card-title>
        <v-card-text>
          <v-row>
            <v-col cols="12" sm="4">
              <v-select
                v-model="newExpense.payer"
                :items="participants"
                label="å¤§å–„äºº"
                hide-details
              ></v-select>
            </v-col>
            <v-col cols="12" sm="4">
              <v-text-field
                v-model.number="newExpense.amount"
                type="number"
                label="é‡‘é¡"
                hide-details
              ></v-text-field>
            </v-col>
            <v-col cols="12" sm="4">
              <v-text-field
                v-model="newExpense.description"
                label="èŠ±å»å“ªäº†"
                hide-details
              ></v-text-field>
            </v-col>
          </v-row>

          <v-card-subtitle>èª°æœ‰ä¾†</v-card-subtitle>
          <v-row>
            <v-col cols="12">
              <v-chip
                v-for="participant in participants"
                :key="participant"
                :class="newExpense.participants.includes(participant) ? 'selected-chip' : 'unselected-chip'"
                @click="toggleParticipant(participant)"
                class="ma-2"
                outlined
              >
                {{ participant }}
              </v-chip>
            </v-col>
          </v-row>

          <v-row class="mt-4">
            <v-col cols="12">
              <v-btn
                color="primary"
                block
                @click="addNewExpense"
                :disabled="!canAddExpense"
              >
                æ–°å¢
              </v-btn>
            </v-col>
          </v-row>
        </v-card-text>
      </v-card>

      <v-card class="mb-6">
        <v-card-title class="d-flex justify-space-between align-center">
          æ”¯å‡ºåˆ—è¡¨
          <v-btn
            color="error"
            variant="text"
            @click="$emit('reset-expenses')"
            :disabled="!expenses.length"
          >
            é‡ç½®æ‰€æœ‰æ”¯å‡º
          </v-btn>
        </v-card-title>
        <v-card-text>
          <v-list v-if="expenses.length">
            <v-list-item
              v-for="(expense, index) in expenses"
              :key="index"
            >
              <v-list-item-title>{{ expense.description }}
                <div class="mt-2">
                <span class="text-subtitle-2">èª°æœ‰ä¾†ï¼š</span>
                <v-row>

                    <v-chip
                      v-for="participant in participants"
                      :key="participant"
                      :class="expense.participants.includes(participant) ? 'selected-chip' : 'unselected-chip'"
                      @click="toggleExpenseParticipant(index, participant)"
                      class="ma-3"
                    >
                      <v-icon v-if="participant === expense.payer" color="red" class="mr-1">
                        mdi-crown
                      </v-icon>
                      {{ participant }}
                    </v-chip>

                </v-row>
              </div></v-list-item-title>
              <v-list-item-subtitle>
                <div class="d-flex align-center">
                  <span>{{ expense.payer }} æ”¯ä»˜äº†</span>
                  <v-text-field
                    v-model.number="expense.amount"
                    type="number"
                    density="compact"
                    class="mx-2"
                    style="width: 100px"
                    hide-details
                    @change="handleAmountChange(index, expense)"
                  ></v-text-field>
                  <span>å…ƒ</span>
                </div>

              </v-list-item-subtitle>
              <template #append>
                <v-btn
                  color="error"
                  icon="mdi-delete"
                  variant="text"
                  @click="$emit('delete-expense', index)"
                ></v-btn>
              </template>
            </v-list-item>
          </v-list>
          <v-alert
            v-else
            type="info"
            text="å°šæœªæ–°å¢æ”¯å‡º"
          ></v-alert>
        </v-card-text>
      </v-card>
    </script>

    <!-- çµæœé¡¯ç¤ºçµ„ä»¶æ¨¡æ¿ -->
    <script type="text/x-template" id="result-display-template">
      <v-card>
        <v-card-title>è¨ˆç®—çµæœ</v-card-title>
        <v-card-text>
          <div v-if="participants.length && expenses.length">
            <div v-html="calculationResult"></div>
            <v-row class="mt-4">
              <v-col cols="12" sm="6">
                <v-btn
                  color="success"
                  block
                  @click="$emit('export')"
                  prepend-icon="mdi-content-copy"
                >
                  åŒ¯å‡ºæ˜ç´°åˆ°å‰ªè²¼ç°¿
                </v-btn>
              </v-col>
              <v-col cols="12" sm="6">
                <v-btn
                  color="primary"
                  block
                  @click="$emit('share')"
                  prepend-icon="mdi-share-variant"
                >
                  è½‰å‚³ç¶²å€
                </v-btn>
              </v-col>
            </v-row>
          </div>
          <v-alert
            v-else
            type="info"
            text="è«‹å¡«å…¥èª°æœ‰ä¾†å’Œèª°èŠ±çš„éŒ¢ä»¥æŸ¥çœ‹è¨ˆç®—çµæœ"
          ></v-alert>
        </v-card-text>
      </v-card>
    </script>

    <script>
      // Base62 ç·¨ç¢¼å‡½æ•¸
      function base62Encode(buffer) {
        const chars =
          "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let result = "";
        let num = BigInt(
          "0x" +
            Array.from(buffer)
              .map((b) => b.toString(16).padStart(2, "0"))
              .join("")
        );
        while (num > 0) {
          result = chars[num % 62n] + result;
          num = num / 62n;
        }
        return result;
      }

      // Base62 è§£ç¢¼å‡½æ•¸
      function base62Decode(str) {
        const chars =
          "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let num = BigInt(0);
        for (let i = 0; i < str.length; i++) {
          num = num * 62n + BigInt(chars.indexOf(str[i]));
        }
        const hex = num.toString(16);
        const buffer = new Uint8Array(hex.length / 2);
        for (let i = 0; i < buffer.length; i++) {
          buffer[i] = parseInt(hex.substr(i * 2, 2), 16);
        }
        return buffer;
      }

      // åƒèˆ‡è€…ç®¡ç†çµ„ä»¶
      const ParticipantManager = {
        template: "#participant-manager-template",
        props: {
          participants: Array,
        },
        data() {
          return {
            newParticipantName: "",
          };
        },
        methods: {
          addNewParticipant() {
            const name = this.newParticipantName.trim();
            if (name && !this.participants.includes(name)) {
              this.$emit("add-participant", name);
              this.newParticipantName = "";
            }
          },
        },
      };

      // æ”¯å‡ºç®¡ç†çµ„ä»¶
      const ExpenseManager = {
        template: "#expense-manager-template",
        props: {
          participants: Array,
          expenses: Array,
        },
        data() {
          return {
            newExpense: {
              payer: "",
              amount: "",
              description: "",
              participants: [],
            },
          };
        },
        methods: {
          addNewExpense() {
            if (
              this.newExpense.payer &&
              this.newExpense.amount > 0 &&
              this.newExpense.description &&
              this.newExpense.participants.length > 0
            ) {
              this.$emit("add-expense", { ...this.newExpense });

              // é‡ç½®è¡¨å–®
              this.newExpense = {
                payer: this.participants[0] || "",
                amount: "",
                description: "",
                participants: [],
              };
            }
          },
          toggleParticipant(participant) {
            const index = this.newExpense.participants.indexOf(participant);
            if (index === -1) {
              this.newExpense.participants.push(participant);
            } else {
              this.newExpense.participants.splice(index, 1);
            }
          },
          toggleExpenseParticipant(expenseIndex, participant) {
            const expense = this.expenses[expenseIndex];
            const index = expense.participants.indexOf(participant);
            if (index === -1) {
              expense.participants.push(participant);
            } else {
              expense.participants.splice(index, 1);
            }
            this.handleParticipantChange(expenseIndex, expense);
          },
          handleAmountChange(index, expense) {
            // ç™¼é€é€šçŸ¥ä»¥æ–°è¨ˆç®—çµæœ
            this.$emit("notify-update", `å·²æ›´æ–°è¨ˆç®—çµæœ`);
          },
          handleParticipantChange(index, expense) {
            // ç¢ºä¿ä»˜æ¬¾äººä¸€å®šæ˜¯åƒèˆ‡è€…
            if (!expense.participants.includes(expense.payer)) {
              expense.participants.push(expense.payer);
            } else {
              this.$emit("notify-update", `å·²æ›´æ–°è¨ˆç®—çµæœ`);
            }
          },
        },
        watch: {
          participants: {
            immediate: true,
            handler(newParticipants) {
              if (newParticipants.length > 0 && !this.newExpense.payer) {
                this.newExpense.payer = newParticipants[0];
              }
            },
          },
        },
        computed: {
          canAddExpense() {
            return (
              this.newExpense.payer &&
              this.newExpense.amount > 0 &&
              this.newExpense.description &&
              this.newExpense.participants.length > 0
            );
          },
        },
      };

      // çµæœé¡¯ç¤ºçµ„ä»¶
      const ResultDisplay = {
        template: "#result-display-template",
        props: {
          participants: Array,
          expenses: Array,
        },
        computed: {
          calculationResult() {
            if (this.participants.length === 0) return "";

            let result = "";
            const totalPaid = {};
            const shouldPay = {};

            // åˆå§‹åŒ–
            this.participants.forEach((name) => {
              totalPaid[name] = 0;
              shouldPay[name] = 0;
            });

            // è¨ˆç®—æ¯ç­†æ”¯å‡º
            this.expenses.forEach((expense) => {
              totalPaid[expense.payer] += expense.amount;
              const perPerson = expense.amount / expense.participants.length;
              expense.participants.forEach((participant) => {
                shouldPay[participant] += perPerson;
              });
            });

            // è¨ˆç®—ç¸½é‡‘é¡
            const totalAmount = Object.values(totalPaid).reduce(
              (a, b) => a + b,
              0
            );
            result += `<p>ç¸½é‡‘é¡ï¼š${totalAmount} å…ƒ</p><br>`;

            // è¨ˆç®—æ¯å€‹æ”¶ä»˜æƒ…æ³
            const debtMatrix = {};
            this.participants.forEach((payer) => {
              debtMatrix[payer] = {};
              this.participants.forEach((receiver) => {
                debtMatrix[payer][receiver] = 0;
              });
            });

            // å»ºç«‹å‚µå‹™é—œä¿‚
            this.expenses.forEach((expense) => {
              const perPerson = expense.amount / expense.participants.length;
              expense.participants.forEach((participant) => {
                if (participant !== expense.payer) {
                  debtMatrix[participant][expense.payer] += perPerson;
                }
              });
            });

            // æŠµéŠ·é›™å‘å‚µå‹™
            this.participants.forEach((person1) => {
              this.participants.forEach((person2) => {
                if (person1 !== person2) {
                  const debt1to2 = debtMatrix[person1][person2];
                  const debt2to1 = debtMatrix[person2][person1];

                  if (debt1to2 > 0 && debt2to1 > 0) {
                    const offsetAmount = Math.min(debt1to2, debt2to1);
                    debtMatrix[person1][person2] -= offsetAmount;
                    debtMatrix[person2][person1] -= offsetAmount;
                  }
                }
              });
            });

            // é¡¯ç¤ºæ¯å€‹äººçš„æ”¯ä»˜æƒ…æ³
            this.participants.forEach((person) => {
              const paid = totalPaid[person] || 0;
              const should = shouldPay[person] || 0;

              result += `<p>${person}:</p>`;
              result += `<p>- å·²æ”¯ä»˜ï¼š${paid.toFixed(2)} å…ƒ</p>`;
              result += `<p>- æ‡‰æ”¯ä»˜ï¼š${should.toFixed(2)} å…ƒ</p><br>`;
            });

            // é¡¯ç¤ºè½‰å¸³å»ºè­°
            result += `<h3>è½‰å¸³å»ºè­°ï¼ˆå·²äº’ç›¸æŠµéŠ·ï¼‰ï¼š</h3>`;
            let hasTransfers = false;

            this.participants.forEach((payer) => {
              this.participants.forEach((receiver) => {
                const amount = debtMatrix[payer][receiver];
                if (amount > 0.01) {
                  hasTransfers = true;
                  result += `<p>${payer} æ‡‰è©²æ”¯ä»˜çµ¦ ${receiver}: ${amount.toFixed(
                    2
                  )} å…ƒ</p>`;
                }
              });
            });

            if (!hasTransfers) {
              result += "<p>æ‰€æœ‰è²»ç”¨å·²å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ã€‚</p>";
            }

            return result;
          },
        },
      };

      // ä¸»æ‡‰ç”¨
      const app = Vue.createApp({
        components: {
          ParticipantManager,
          ExpenseManager,
          ResultDisplay,
        },
        data() {
          return {
            participants: [],
            expenses: [],
            snackbar: {
              show: false,
              text: "",
              color: "success",
            },
            dialog: {
              show: false,
              title: "",
              text: "",
              confirmText: "ç¢ºèª",
              cancelText: "å–æ¶ˆ",
              confirmColor: "error",
              callback: null,
            },
          };
        },
        methods: {
          encodeData() {
            const data = {
              p: this.participants,
              e: this.expenses.map((expense) => ({
                p: expense.payer,
                a: expense.amount,
                d: expense.description,
                ps: expense.participants,
              })),
            };
            const jsonString = JSON.stringify(data);
            const utf8Bytes = new TextEncoder().encode(jsonString);
            const compressed = pako.deflate(utf8Bytes);
            return base62Encode(compressed);
          },
          decodeData(encoded) {
            const compressed = base62Decode(encoded);
            const utf8Bytes = pako.inflate(compressed);
            const jsonString = new TextDecoder().decode(utf8Bytes);
            const data = JSON.parse(jsonString);
            return {
              participants: data.p,
              expenses: data.e.map((expense) => ({
                payer: expense.p,
                amount: expense.a,
                description: expense.d,
                participants: expense.ps,
              })),
            };
          },
          async shareDetails() {
            const encoded = this.encodeData();
            const shareUrl = `${window.location.origin}${window.location.pathname}#${encoded}`;

            const shareText =
              "èšæœƒè²»ç”¨åˆ†æ”¤æ˜ç´°\n" +
              "=================\n\n" +
              `ç¸½é‡‘é¡ï¼š${this.expenses.reduce(
                (sum, exp) => sum + exp.amount,
                0
              )} å…ƒ\n` +
              `åƒäººæ•¸ï¼š${this.participants.length} äºº\n\n` +
              "é»æ“Šé€£çµæŸ¥çœ‹è©³ç´°è³‡è¨Šï¼š";

            if (navigator.share) {
              try {
                await navigator.share({
                  title: "èšæœƒè²»ç”¨åˆ†æ”¤æ˜ç´°",
                  text: shareText,
                  url: shareUrl,
                });
              } catch (err) {
                if (err.name !== "AbortError") {
                  this.fallbackShare(shareUrl);
                }
              }
            } else {
              this.fallbackShare(shareUrl);
            }
          },
          fallbackShare(shareUrl) {
            navigator.clipboard
              .writeText(shareUrl)
              .then(() =>
                this.showNotification("åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼", "success")
              )
              .catch(() => {
                const tempInput = document.createElement("input");
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                this.showNotification("åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼", "success");
              });
          },
          addParticipant(name) {
            this.participants.push(name);
            this.showNotification(`${name} ä¾†äº†ä¾†äº†`);
          },
          deleteParticipant(index) {
            const participantToDelete = this.participants[index];
            const hasExpenses = this.expenses.some(
              (expense) =>
                expense.payer === participantToDelete ||
                expense.participants.includes(participantToDelete)
            );

            if (hasExpenses) {
              this.showConfirmDialog({
                title: "ä»–æ²’ä¾†å—?",
                text: `${participantToDelete} æœ‰ç›¸é—œçš„æ”¯å‡ºè¨˜éŒ„ï¼Œç³»çµ±å°‡ï¼š\n1. åˆªé™¤äººæ”¯ä»˜çš„æ”¯å‡º\n2. å°‡æ­¤äººå¾å…¶ä»–æ”¯å‡ºçš„åƒèˆ‡è€…ä¸­ç§»é™¤\n\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ`,
                callback: () => {
                  // æ‰¾å‡ºä¸¦é€šçŸ¥è¢«åˆªé™¤çš„æ”¯å‡º
                  const deletedExpenses = this.expenses.filter(
                    (expense) => expense.payer === participantToDelete
                  );
                  if (deletedExpenses.length > 0) {
                    this.showNotification(
                      `å·²åˆªé™¤ ${participantToDelete} æ”¯ä»˜çš„æ”¯å‡ºï¼š${deletedExpenses
                        .map((e) => e.description)
                        .join(", ")}`,
                      "warning"
                    );
                  }

                  // æ‰¾å‡ºä¸¦é€šçŸ¥è¢«ç§»é™¤åƒèˆ‡è€…çš„æ”¯å‡º
                  const modifiedExpenses = this.expenses.filter(
                    (expense) =>
                      expense.payer !== participantToDelete &&
                      expense.participants.includes(participantToDelete)
                  );
                  if (modifiedExpenses.length > 0) {
                    this.showNotification(
                      `å·²å°‡ ${participantToDelete} å¾ä»¥ä¸‹æ”¯å‡ºä¸­ç§»é™¤ï¼š${modifiedExpenses
                        .map((e) => e.description)
                        .join(", ")}`,
                      "warning"
                    );
                  }

                  // è™•ç†æ”¯å‡ºè¨˜éŒ„
                  this.expenses = this.expenses
                    .map((expense) => {
                      if (expense.payer === participantToDelete) {
                        return null;
                      }
                      if (expense.participants.includes(participantToDelete)) {
                        return {
                          ...expense,
                          participants: expense.participants.filter(
                            (p) => p !== participantToDelete
                          ),
                        };
                      }
                      return expense;
                    })
                    .filter(
                      (expense) =>
                        expense !== null && expense.participants.length > 0
                    );

                  this.participants.splice(index, 1);
                  this.showNotification(
                    `ä»–æ²’ä¾†ï¼š${participantToDelete}`,
                    "warning"
                  );
                },
              });
            } else {
              this.showConfirmDialog({
                title: "ä»–æ²’ä¾†å—?",
                text: `ç¢ºå®šè¦åˆªé™¤ ${participantToDelete} å—ï¼Ÿ`,
                callback: () => {
                  this.participants.splice(index, 1);
                  this.showNotification(
                    `å·²ç¢ºå®šä»–æ²’ä¾†ï¼š${participantToDelete}ï¼ˆç„¡ç›¸é—œæ”¯å‡ºï¼‰`,
                    "warning"
                  );
                },
              });
            }
          },
          resetParticipants() {
            this.showConfirmDialog({
              title: "ç¢ºèªé‡ç½®",
              text: "ä½ ç¢ºå®šå¤§å®¶éƒ½æ²’ä¾†?è¦æ¸…æ‰äº†å–”",
              callback: () => {
                const participantCount = this.participants.length;
                const expenseCount = this.expenses.length;
                const totalAmount = this.expenses.reduce(
                  (sum, exp) => sum + exp.amount,
                  0
                );

                this.participants = [];
                this.expenses = [];
                this.showNotification(
                  `å·²é‡ç½®æ‰€æœ‰è³‡æ–™ï¼ˆç¸½äººæ•¸ï¼š${participantCount} äººï¼Œæ”¯å‡ºï¼š${expenseCount} ç­†ï¼Œç¸½é‡‘é¡ï¼š${totalAmount} å…ƒï¼‰`,
                  "warning"
                );
              },
            });
          },
          addExpense(expense) {
            this.expenses.push(expense);
            this.showNotification(
              `å·²æ–°å¢æ”¯å‡ºï¼š${expense.description} (${
                expense.amount
              } å…ƒ)\nèª°æœ‰ä¾†ï¼š${expense.participants.join(", ")}`
            );
          },
          deleteExpense(index) {
            const expense = this.expenses[index];
            this.showConfirmDialog({
              title: "ç¢ºèªåˆªé™¤æ”¯å‡º",
              text: `ç¢ºå®šè¦åˆªé™¤æ”¯å‡º "${expense.description}" å—ï¼Ÿ`,
              callback: () => {
                this.expenses.splice(index, 1);
                this.showNotification(
                  `å·²åˆªé™¤æ”¯å‡ºï¼š${expense.description}`,
                  "warning"
                );
              },
            });
          },
          resetExpenses() {
            this.showConfirmDialog({
              title: "ç¢ºèªé‡ç½®",
              text: "ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ”¯å‡ºç´€éŒ„å—ï¼Ÿ",
              callback: () => {
                const count = this.expenses.length;
                const total = this.expenses.reduce(
                  (sum, exp) => sum + exp.amount,
                  0
                );
                this.expenses = [];
                this.showNotification(
                  `å·²æ¸…ç©ºæ‰€æœ‰æ”¯å‡ºè¨˜éŒ„ï¼ˆå…± ${count} ç­†ï¼Œç¸½é‡‘é¡ ${total} å…ƒï¼‰`,
                  "warning"
                );
              },
            });
          },
          exportDetails() {
            let exportText = "ä¸€æ¬¡çœ‹æ¸…æ¥š\n";
            exportText += "=================\n\n";

            const shareUrl = `${window.location.origin}${
              window.location.pathname
            }#${this.encodeData()}`;
            exportText += "å…§å®¹ç¶²å€ï¼š\n";
            exportText += shareUrl + "\n\n";

            // åŠ å…¥åƒèˆ‡è€…åˆ—è¡¨
            exportText += "èª°æœ‰ä¾†ï¼š\n";
            this.participants.forEach((name) => {
              exportText += `- ${name}\n`;
            });
            exportText += "\n";

            // åŠ å…¥æ”¯å‡ºåˆ—è¡¨
            exportText += "æ”¯å‡ºåˆ—è¡¨ï¼š\n";
            this.expenses.forEach((expense, index) => {
              exportText += `${index + 1}. ${expense.description}\n`;
              exportText += `   ä»˜æ¬¾äººï¼š${expense.payer}\n`;
              exportText += `   é‡‘é¡ï¼š${expense.amount} å…ƒ\n`;
              exportText += `   ä»–æœ‰ä¾†ï¼š${expense.participants.join(", ")}\n\n`;
            });

            // åŠ å…¥è¨ˆç®—çµæœ
            const totalAmount = this.expenses.reduce(
              (sum, exp) => sum + exp.amount,
              0
            );
            exportText += `ç¸½é‡‘é¡ï¼š${totalAmount} å…ƒ\n\n`;

            // è¨ˆç®—è½‰å¸³å»ºè­°
            exportText += "è½‰å¸³å»ºè­°ï¼š\n";
            const debtMatrix = {};
            this.participants.forEach((payer) => {
              debtMatrix[payer] = {};
              this.participants.forEach((receiver) => {
                debtMatrix[payer][receiver] = 0;
              });
            });

            this.expenses.forEach((expense) => {
              const perPerson = expense.amount / expense.participants.length;
              expense.participants.forEach((participant) => {
                if (participant !== expense.payer) {
                  debtMatrix[participant][expense.payer] += perPerson;
                }
              });
            });

            this.participants.forEach((person1) => {
              this.participants.forEach((person2) => {
                if (person1 !== person2) {
                  const debt1to2 = debtMatrix[person1][person2];
                  const debt2to1 = debtMatrix[person2][person1];

                  if (debt1to2 > 0 && debt2to1 > 0) {
                    const offsetAmount = Math.min(debt1to2, debt2to1);
                    debtMatrix[person1][person2] -= offsetAmount;
                    debtMatrix[person2][person1] -= offsetAmount;
                  }
                }
              });
            });

            let hasTransfers = false;
            this.participants.forEach((payer) => {
              this.participants.forEach((receiver) => {
                const amount = debtMatrix[payer][receiver];
                if (amount > 0.01) {
                  hasTransfers = true;
                  exportText += `${payer} æ‡‰è©²æ”¯ä»˜çµ¦ ${receiver}: ${amount.toFixed(
                    2
                  )} å…ƒ\n`;
                }
              });
            });

            if (!hasTransfers) {
              exportText += "æ‰€æœ‰è²»ç”¨å·²å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ã€‚\n";
            }

            navigator.clipboard
              .writeText(exportText)
              .then(() => {
                this.showNotification("æ˜ç´°å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼", "success");
              })
              .catch((err) => {
                console.error("è¤‡è£½å¤±ï¼š", err);
                this.showNotification("è¤‡è£½å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
              });
          },
          showNotification(text, color = "success") {
            this.snackbar.text = text;
            this.snackbar.color = color;
            this.snackbar.show = true;
          },
          showConfirmDialog({
            title,
            text,
            confirmText = "ç¢ºèª",
            cancelText = "å–æ¶ˆ",
            confirmColor = "error",
            callback,
          }) {
            this.dialog = {
              show: true,
              title,
              text,
              confirmText,
              cancelText,
              confirmColor,
              callback,
            };
          },
          handleDialogConfirm() {
            this.dialog.show = false;
            if (this.dialog.callback) {
              this.dialog.callback();
            }
          },
          updateExpense(index, expense) {
            console.log("index", index);
            console.log("expense", expense);
            this.showNotification("å·²æ›´æ–°æ”¯å‡º");
          },
        },
        mounted() {
          // å¾ URL è¼‰å…¥è³‡æ–™
          const hash = window.location.hash.slice(1);
          if (hash) {
            try {
              const data = this.decodeData(hash);
              if (data && data.participants && data.expenses) {
                this.participants = data.participants;
                this.expenses = data.expenses;
              }
            } catch (error) {
              console.error("è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
            }
          }
        },
      });

      // æ­£ç¢ºçš„åˆå§‹åŒ–é †åº
      const vuetify = Vuetify.createVuetify(); // å…ˆå‰µå»º Vuetify å¯¦ä¾‹
      app.use(vuetify); // ç„¶å¾Œä½¿ç”¨å®ƒ
      app.mount("#app"); // æœ€å¾Œæ›è¼‰æ‡‰ç”¨
    </script>

    <!-- æ–°å¢æ¨£å¼ -->
    <style>
      .d-inline-block {
        display: inline-block !important;
      }
      .white-space-pre-line {
        white-space: pre-line;
      }
      .checkbox-container {
        max-height: 300px; /* è¨­ç½®æœ€å¤§é«˜åº¦ */
        overflow-y: auto; /* æ·»åŠ å‚ç›´æ»¾å‹•æ¢ */
      }
      .expense-participants {
        max-height: 150px; /* è¨­ç½®æ”¯å‡ºåˆ—è¡¨ä¸­åƒèˆ‡è€…çš„æœ€å¤§é«˜åº¦ */
        overflow-y: auto; /* æ·»åŠ å‚ç›´æ»¾å‹•æ¢ */
      }
    </style>
  </body>
</html>
