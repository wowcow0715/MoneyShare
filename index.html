<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>聚會費用分攤計算器</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 15px;
        background-color: #f5f5f5;
      }

      h1 {
        font-size: 1.8rem;
        text-align: center;
        color: #2c3e50;
      }

      h2 {
        font-size: 1.4rem;
        color: #34495e;
      }

      .expense-form,
      .expense-list,
      .result {
        background-color: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* 輸入框和選擇框樣式 */
      input,
      select {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px; /* 手機上更容易點擊 */
      }

      /* 按鈕樣式 */
      button {
        width: 100%;
        padding: 12px;
        margin: 5px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: #3498db;
        color: white;
        font-size: 16px;
      }

      button:hover {
        opacity: 0.9;
      }

      button[onclick*="reset"] {
        background-color: #e74c3c;
      }

      /* 參與者勾選框容器 */
      #participantCheckboxes {
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      /* 參與者勾選框標籤 */
      #participantCheckboxes label {
        display: block;
        padding: 8px 0;
        font-size: 16px;
      }

      #participantCheckboxes input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
        transform: scale(1.2); /* 讓勾選框更大，更容易點擊 */
      }

      /* 列表樣式 */
      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        word-break: break-all;
      }

      /* 結果區塊樣式 */
      .result {
        background-color: #f8f9fa;
      }

      .result p {
        margin: 8px 0;
        line-height: 1.5;
      }

      /* 響應式設計 */
      @media (min-width: 768px) {
        .form-row {
          display: flex;
          gap: 10px;
        }

        .form-row input,
        .form-row select {
          flex: 1;
        }

        button {
          width: auto;
          min-width: 120px;
        }

        #participantCheckboxes label {
          display: inline-block;
          margin-right: 15px;
        }
      }

      /* 新增支出表單的響應式布局 */
      .expense-inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      @media (min-width: 768px) {
        .expense-inputs {
          flex-direction: row;
        }
      }

      .deletable-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }

      .delete-btn {
        background-color: #ff5252;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 14px;
        min-width: auto !important;
        margin-left: 10px;
      }

      .delete-btn:hover {
        background-color: #ff1744;
      }

      .list-item-content {
        flex-grow: 1;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <h1>聚會費用分攤計算器</h1>

    <!-- 新增參與者 -->
    <div class="expense-form">
      <h2>新增參與者</h2>
      <div class="form-row">
        <input type="text" id="newParticipant" placeholder="輸入參與者姓名" />
        <button onclick="addParticipant()">新增參與者</button>
      </div>
    </div>

    <!-- 在新增參與者區塊後面加入參與者列表顯示 -->
    <div class="expense-form">
      <h2>目前參與者</h2>
      <ul id="participantList" class="deletable-list"></ul>
      <button
        onclick="resetParticipants()"
        style="background-color: #ffebee; color: #d32f2f"
      >
        重置所有參與者
      </button>
    </div>

    <!-- 新增支出 -->
    <div class="expense-form">
      <h2>新增支出</h2>
      <div class="expense-inputs">
        <select id="payer"></select>
        <input type="number" id="amount" placeholder="金額" />
        <input type="text" id="description" placeholder="支出描述" />
      </div>
      <div id="participantCheckboxes"></div>
      <button onclick="addExpense()">新增支出</button>
    </div>

    <!-- 支出列表 -->
    <div class="expense-list">
      <h2>支出列表</h2>
      <ul id="expenseList" class="deletable-list"></ul>
      <button
        onclick="resetExpenses()"
        style="background-color: #ffebee; color: #d32f2f"
      >
        重置所有支出
      </button>
    </div>

    <!-- 計算結果 -->
    <div class="result">
      <h2>計算結果</h2>
      <div id="result"></div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap">
        <button onclick="exportDetails()" style="background-color: #4caf50">
          匯出明細到剪貼簿
        </button>
        <button onclick="shareDetails()" style="background-color: #2196f3">
          分享結果
        </button>
      </div>
    </div>

    <script>
      let participants = [];
      let expenses = [];

      function addParticipant() {
        const name = document.getElementById("newParticipant").value.trim();
        if (name && !participants.includes(name)) {
          participants.push(name);
          updatePayerSelect();
          updateParticipantList();
          document.getElementById("newParticipant").value = "";
          calculate();
        }
      }

      function updatePayerSelect() {
        const select = document.getElementById("payer");
        const checkboxDiv = document.getElementById("participantCheckboxes");

        select.innerHTML = "";
        checkboxDiv.innerHTML = "<p>參與者：</p>";

        participants.forEach((name) => {
          // 更新付款人選單
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);

          // 新增參與者勾選框
          const label = document.createElement("label");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = name;
          checkbox.id = `participant-${name}`;
          checkbox.checked = true;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(` ${name}`));
          checkboxDiv.appendChild(label);
        });
      }

      function addExpense() {
        const payer = document.getElementById("payer").value;
        const amount = parseFloat(document.getElementById("amount").value);
        const description = document.getElementById("description").value;

        // 獲取被選中的參與者
        const selectedParticipants = participants.filter(
          (name) => document.getElementById(`participant-${name}`).checked
        );

        if (payer && amount && description && selectedParticipants.length > 0) {
          expenses.push({
            payer,
            amount,
            description,
            participants: selectedParticipants,
          });
          updateExpenseList();
          calculate();

          document.getElementById("amount").value = "";
          document.getElementById("description").value = "";
        }
      }

      function updateExpenseList() {
        const list = document.getElementById("expenseList");
        list.innerHTML = "";
        expenses.forEach((expense, index) => {
          const li = document.createElement("li");

          const content = document.createElement("span");
          content.className = "list-item-content";
          content.textContent = `${expense.payer} 支付了 ${
            expense.amount
          } 元 (${expense.description}) - 參與者: ${expense.participants.join(
            ", "
          )}`;
          li.appendChild(content);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "刪除";
          deleteBtn.onclick = () => deleteExpense(index);
          li.appendChild(deleteBtn);

          list.appendChild(li);
        });
      }

      function calculate() {
        if (participants.length === 0) return;

        // 計算每個人的總支出和��付金額
        const totalPaid = {};
        const shouldPay = {};
        participants.forEach((name) => {
          totalPaid[name] = 0;
          shouldPay[name] = 0;
        });

        // 計算每筆支出的分攤
        expenses.forEach((expense) => {
          totalPaid[expense.payer] += expense.amount;
          const perPerson = expense.amount / expense.participants.length;
          expense.participants.forEach((participant) => {
            shouldPay[participant] += perPerson;
          });
        });

        // 顯示結果
        const result = document.getElementById("result");
        const totalAmount = Object.values(totalPaid).reduce((a, b) => a + b, 0);
        result.innerHTML = `<p>總金額：${totalAmount} 元</p><br>`;

        // 建立債務矩陣（誰欠誰多少錢）
        const debtMatrix = {};
        participants.forEach((payer) => {
          debtMatrix[payer] = {};
          participants.forEach((receiver) => {
            debtMatrix[payer][receiver] = 0;
          });
        });

        // 計算每筆支出的債務關係
        expenses.forEach((expense) => {
          const perPerson = expense.amount / expense.participants.length;
          expense.participants.forEach((participant) => {
            if (participant !== expense.payer) {
              debtMatrix[participant][expense.payer] += perPerson;
            }
          });
        });

        // 抵銷雙向債務
        participants.forEach((person1) => {
          participants.forEach((person2) => {
            if (person1 !== person2) {
              const debt1to2 = debtMatrix[person1][person2];
              const debt2to1 = debtMatrix[person2][person1];

              if (debt1to2 > 0 && debt2to1 > 0) {
                // 抵銷較小的金額
                const offsetAmount = Math.min(debt1to2, debt2to1);
                debtMatrix[person1][person2] -= offsetAmount;
                debtMatrix[person2][person1] -= offsetAmount;
              }
            }
          });
        });

        // 顯示每個人的支付和收款情況
        participants.forEach((person) => {
          const paid = totalPaid[person] || 0;
          const should = shouldPay[person] || 0;

          result.innerHTML += `<p>${person}:</p>`;
          result.innerHTML += `<p>- 已支付：${paid.toFixed(2)} 元</p>`;
          result.innerHTML += `<p>- 應支付：${should.toFixed(2)} 元</p>`;
          result.innerHTML += "<br>";
        });

        // 顯示最終轉帳建議（已抵銷後的結果）
        result.innerHTML += `<h3>轉帳建議（已互相抵銷）：</h3>`;
        let hasTransfers = false;

        participants.forEach((payer) => {
          participants.forEach((receiver) => {
            const amount = debtMatrix[payer][receiver];
            if (amount > 0.01) {
              // 忽略小於1分的金額
              hasTransfers = true;
              result.innerHTML += `<p>${payer} 應該支付給 ${receiver}: ${amount.toFixed(
                2
              )} 元</p>`;
            }
          });
        });

        if (!hasTransfers) {
          result.innerHTML += "<p>所有費用已平衡，無需轉帳。</p>";
        }
      }

      // 新增更新參與者列表的函數
      function updateParticipantList() {
        const list = document.getElementById("participantList");
        list.innerHTML = "";
        participants.forEach((name, index) => {
          const li = document.createElement("li");

          const content = document.createElement("span");
          content.className = "list-item-content";
          content.textContent = name;
          li.appendChild(content);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "刪除";
          deleteBtn.onclick = () => deleteParticipant(index);
          li.appendChild(deleteBtn);

          list.appendChild(li);
        });
      }

      // 修改刪除參與者的函數
      function deleteParticipant(index) {
        const participantToDelete = participants[index];

        // 檢查是否有相關支出
        const hasExpenses = expenses.some(
          (expense) =>
            expense.payer === participantToDelete ||
            expense.participants.includes(participantToDelete)
        );

        if (hasExpenses) {
          if (
            confirm(
              `${participantToDelete} 有相關的支出記錄，系統將：\n1. 刪除此人支付的支出\n2. 將此人從其他支出的參與者中移除\n\n確定要刪除嗎？`
            )
          ) {
            // 處理支出記錄
            expenses = expenses
              .map((expense) => {
                // 如果是該參與者支付的支出，直接移除
                if (expense.payer === participantToDelete) {
                  return null;
                }
                // 如果該參與者只是參與者之一，將其從參與者列表中移除
                if (expense.participants.includes(participantToDelete)) {
                  return {
                    ...expense,
                    participants: expense.participants.filter(
                      (p) => p !== participantToDelete
                    ),
                  };
                }
                return expense;
              })
              .filter(
                (expense) =>
                  // 移除 null 的支出記錄和沒有參與者的支出
                  expense !== null && expense.participants.length > 0
              );

            // 移除參與者
            participants.splice(index, 1);

            // 更新顯示
            updateParticipantList();
            updatePayerSelect();
            updateExpenseList();
            calculate();
          }
        } else {
          // 如果沒有相關支出，直接刪除參與者
          participants.splice(index, 1);
          updateParticipantList();
          updatePayerSelect();
          calculate();
        }
      }

      // 新增重置參與者的函數
      function resetParticipants() {
        if (
          confirm("確定要清空所有參與者嗎？這個動作會同時清空所有支出紀錄。")
        ) {
          participants = [];
          expenses = []; // 清空支出，因為支出需要參與者資訊
          updateParticipantList();
          updatePayerSelect();
          updateExpenseList();
          calculate();
        }
      }

      // 新增重置支出的函數
      function resetExpenses() {
        if (confirm("確定要清空所有支出紀錄嗎？")) {
          expenses = [];
          updateExpenseList();
          calculate();
        }
      }

      // 新增從 URL 載入資料的功能
      function loadFromUrl() {
        const hash = window.location.hash.slice(1); // 移除 # 符號
        if (hash) {
          try {
            const data = decodeData(hash);
            if (data && data.participants && data.expenses) {
              participants = data.participants;
              expenses = data.expenses;

              // 更新所有顯示
              updateParticipantList();
              updatePayerSelect();
              updateExpenseList();
              calculate();
            } else {
              console.error("載入的資料格式不正確");
            }
          } catch (error) {
            console.error("載入資料時發生錯誤：", error);
          }
        }
      }

      // 修改 decodeData 函數，加入更多錯誤處理
      function decodeData(encoded) {
        try {
          // 處理 URL 編碼問題
          const decoded = decodeURIComponent(atob(encoded));
          const data = JSON.parse(decoded);

          // 驗證資料結構
          if (!data.participants || !Array.isArray(data.participants)) {
            throw new Error("參與者資料格式不正確");
          }
          if (!data.expenses || !Array.isArray(data.expenses)) {
            throw new Error("支出資料格式不正確");
          }

          return data;
        } catch (e) {
          console.error("解碼失敗：", e);
          alert("解析分享連結失敗，請確認連結是否完整。");
          return null;
        }
      }

      // 修改 encodeData 函數，確保資料格式正確
      function encodeData() {
        try {
          const data = {
            participants: participants,
            expenses: expenses,
          };
          const jsonString = JSON.stringify(data);
          return btoa(encodeURIComponent(jsonString));
        } catch (e) {
          console.error("編碼失敗：", e);
          alert("產生分享連結時發生錯誤。");
          return null;
        }
      }

      // 新增 shareDetails 函數
      async function shareDetails() {
        const encoded = encodeData();
        const shareUrl = `${window.location.origin}${window.location.pathname}#${encoded}`;

        // 準備分享文字
        const shareText =
          "聚會費用分攤明細\n" +
          "=================\n\n" +
          `總金額：${Object.values(expenses).reduce(
            (sum, exp) => sum + exp.amount,
            0
          )} 元\n` +
          `參與人數：${participants.length} 人\n\n` +
          "點擊連結查看詳細資訊：";

        // 檢查是否支援 Share API
        if (navigator.share) {
          try {
            await navigator.share({
              title: "聚會費用分攤明細",
              text: shareText,
              url: shareUrl,
            });
          } catch (err) {
            if (err.name !== "AbortError") {
              fallbackShare(shareUrl);
            }
          }
        } else {
          fallbackShare(shareUrl);
        }
      }

      // 新增備用分享方法
      function fallbackShare(shareUrl) {
        // 建立臨時輸入框
        const tempInput = document.createElement("input");
        tempInput.value = shareUrl;
        document.body.appendChild(tempInput);

        // 選取並複製
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);

        alert("分享連結已複製到剪貼簿！\n您可以直接分享給其他人。");
      }

      // 修改 generateShareLink 函數名稱為 getShareUrl（作為輔助函數）
      function getShareUrl() {
        const encoded = encodeData();
        return `${window.location.origin}${window.location.pathname}#${encoded}`;
      }

      // 修改 exportDetails 函數中的分享連結部分
      function exportDetails() {
        let exportText = "聚會費用分攤明細\n";
        exportText += "=================\n\n";

        // 加入分享連結
        const shareUrl = getShareUrl();
        exportText += "分享連結：\n";
        exportText += shareUrl + "\n\n";

        // 新增參與者清單
        exportText += "參與者：\n";
        participants.forEach((name) => {
          exportText += `- ${name}\n`;
        });
        exportText += "\n";

        // 新增支出明細
        exportText += "支出明細：\n";
        expenses.forEach((expense, index) => {
          exportText += `${index + 1}. ${expense.description}\n`;
          exportText += `   付款人：${expense.payer}\n`;
          exportText += `   金額：${expense.amount} 元\n`;
          exportText += `   參與者：${expense.participants.join(", ")}\n`;
          exportText += "\n";
        });

        // 計算總金額和每人支付情況
        const totalPaid = {};
        const shouldPay = {};
        participants.forEach((name) => {
          totalPaid[name] = 0;
          shouldPay[name] = 0;
        });

        expenses.forEach((expense) => {
          totalPaid[expense.payer] += expense.amount;
          const perPerson = expense.amount / expense.participants.length;
          expense.participants.forEach((participant) => {
            shouldPay[participant] += perPerson;
          });
        });

        const totalAmount = Object.values(totalPaid).reduce((a, b) => a + b, 0);

        // 新增總結算明細
        exportText += "結算明細：\n";
        exportText += `總金額：${totalAmount} 元\n\n`;

        participants.forEach((person) => {
          const paid = totalPaid[person] || 0;
          const should = shouldPay[person] || 0;
          exportText += `${person}:\n`;
          exportText += `- 已支付：${paid.toFixed(2)} 元\n`;
          exportText += `- 應支付：${should.toFixed(2)} 元\n\n`;
        });

        // 新增轉帳建議
        exportText += "轉帳建議（已互相抵銷）：\n";
        let hasTransfers = false;

        // 建立債務矩陣
        const debtMatrix = {};
        participants.forEach((payer) => {
          debtMatrix[payer] = {};
          participants.forEach((receiver) => {
            debtMatrix[payer][receiver] = 0;
          });
        });

        // 計算債務關係
        expenses.forEach((expense) => {
          const perPerson = expense.amount / expense.participants.length;
          expense.participants.forEach((participant) => {
            if (participant !== expense.payer) {
              debtMatrix[participant][expense.payer] += perPerson;
            }
          });
        });

        // 抵銷雙向債務
        participants.forEach((person1) => {
          participants.forEach((person2) => {
            if (person1 !== person2) {
              const debt1to2 = debtMatrix[person1][person2];
              const debt2to1 = debtMatrix[person2][person1];

              if (debt1to2 > 0 && debt2to1 > 0) {
                const offsetAmount = Math.min(debt1to2, debt2to1);
                debtMatrix[person1][person2] -= offsetAmount;
                debtMatrix[person2][person1] -= offsetAmount;
              }
            }
          });
        });

        // 加入轉帳建議
        participants.forEach((payer) => {
          participants.forEach((receiver) => {
            const amount = debtMatrix[payer][receiver];
            if (amount > 0.01) {
              hasTransfers = true;
              exportText += `${payer} 應該支付給 ${receiver}: ${amount.toFixed(
                2
              )} 元\n`;
            }
          });
        });

        if (!hasTransfers) {
          exportText += "所有費用已平衡，無需轉帳。\n";
        }

        // 複製到剪貼簿
        navigator.clipboard
          .writeText(exportText)
          .then(() => {
            alert("明細已複製到剪貼簿！");
          })
          .catch((err) => {
            console.error("複製失敗：", err);
            alert("複製失敗，請手動複製：\n\n" + exportText);
          });
      }

      // 新增刪除支出的函數
      function deleteExpense(index) {
        if (confirm("確定要刪除這筆支出嗎？")) {
          expenses.splice(index, 1);
          updateExpenseList();
          calculate();
        }
      }

      // 在頁面載入時檢查 URL 參數
      window.addEventListener("load", loadFromUrl);
      // 監聽 hash 變更事件
      window.addEventListener("hashchange", loadFromUrl);
    </script>
  </body>
</html>
